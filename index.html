<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahtzee Game - Enhanced Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .game-title {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .game-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Setup Screen */
        .setup-screen {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            max-width: 600px;
            margin: 0 auto;
        }

        .setup-screen h2 {
            margin-bottom: 30px;
            color: #2a5298;
            font-size: 2rem;
        }

        .player-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .player-input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }

        .player-input:focus {
            outline: none;
            border-color: #2a5298;
        }

        .start-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .start-button:hover {
            transform: translateY(-2px);
        }

        /* Game Screen */
        .game-screen {
            display: none !important;
        }

        .game-screen.show {
            display: block !important;
        }

        .game-board {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 20px;
        }

        /* Scorecards */
        .scorecards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .scorecard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .scorecard.active {
            border: 3px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            transform: scale(1.02);
        }

        .player-header {
            text-align: center;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 15px 15px 0 0;
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .score-category {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .score-category:hover:not(.scored) {
            background-color: #f0f8ff;
        }

        .score-category.scored {
            background-color: #fff3cd;
            border: 2px solid #f0ad4e;
            cursor: default;
        }

        .score-category.potential {
            background-color: #d4edda;
            border: 2px dashed #28a745;
            color: #155724;
        }

        .category-name {
            font-weight: 500;
        }

        .category-score {
            font-weight: bold;
            color: #2a5298;
        }

        .total-section {
            border-top: 2px solid #2a5298;
            margin-top: 15px;
            padding-top: 15px;
            text-align: center;
        }

        .total-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2a5298;
        }

        /* Dice Area */
        .dice-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .turn-info {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .die {
            width: 70px;
            height: 70px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            position: relative;
        }

        .die:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .die.held {
            background: #FFD700;
            border-color: #FFA500;
            transform: scale(0.95);
        }

        .die.shaking {
            animation: shake 0.1s infinite;
        }

        @keyframes shake {
            0% { transform: translate(0px, 0px) rotate(0deg); }
            10% { transform: translate(-2px, -2px) rotate(-2deg); }
            20% { transform: translate(-2px, 2px) rotate(2deg); }
            30% { transform: translate(2px, 2px) rotate(0deg); }
            40% { transform: translate(2px, -2px) rotate(2deg); }
            50% { transform: translate(-2px, -2px) rotate(-2deg); }
            60% { transform: translate(-2px, 2px) rotate(0deg); }
            70% { transform: translate(2px, 2px) rotate(-2deg); }
            80% { transform: translate(-2px, -2px) rotate(2deg); }
            90% { transform: translate(2px, -2px) rotate(0deg); }
            100% { transform: translate(0px, 0px) rotate(-2deg); }
        }

        .roll-controls {
            margin: 25px 0;
        }

        .roll-area {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .roll-area:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .roll-area:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .roll-info {
            margin: 15px 0;
            font-size: 1.1rem;
            color: #666;
        }

        /* Yahtzee Challenge */
        .yahtzee-challenge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.05); }
        }

        .yahtzee-challenge h2 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .yahtzee-button {
            background: linear-gradient(135deg, #ff4444, #cc3333);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .yahtzee-button:hover {
            transform: scale(1.1);
        }

        .countdown {
            font-size: 1.2rem;
            margin-top: 15px;
            color: #333;
        }

        /* Game Over Screen */
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .game-over-content {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }

        .winner-announcement {
            font-size: 3rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .final-scores {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .restart-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restart-button:hover {
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .game-board {
                grid-template-columns: 1fr;
            }
            
            .dice-area {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .player-inputs {
                grid-template-columns: 1fr;
            }
            
            .dice-container {
                gap: 10px;
            }
            
            .die {
                width: 60px;
                height: 60px;
                font-size: 2.5rem;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1 class="game-title">🎲 YAHTZEE! 🎲</h1>
            <p class="game-subtitle">Roll for Glory - Enhanced Edition</p>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <h2>Enter Player Names</h2>
            <p style="margin-bottom: 20px; color: #666;">2-4 Players Required</p>
            <div class="player-inputs">
                <input type="text" class="player-input" id="player1" placeholder="Player 1 (Required)" maxlength="12">
                <input type="text" class="player-input" id="player2" placeholder="Player 2 (Required)" maxlength="12">
                <input type="text" class="player-input" id="player3" placeholder="Player 3 (Optional)" maxlength="12">
                <input type="text" class="player-input" id="player4" placeholder="Player 4 (Optional)" maxlength="12">
            </div>
            <button class="start-button" onclick="startGame()">Start Game!</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="game-board">
                <div class="scorecards" id="scorecards">
                    <!-- Scorecards will be generated dynamically -->
                </div>

                <div class="dice-area">
                    <div class="turn-info" id="turnInfo">
                        Player 1's Turn - Roll 1 of 3
                    </div>

                    <div class="dice-container" id="diceContainer">
                        <div class="die" id="die0">⚀</div>
                        <div class="die" id="die1">⚀</div>
                        <div class="die" id="die2">⚀</div>
                        <div class="die" id="die3">⚀</div>
                        <div class="die" id="die4">⚀</div>
                    </div>

                    <div class="roll-controls">
                        <button class="roll-area" id="rollButton" onmousedown="startShaking()" onmouseup="rollDice()" onmouseleave="rollDice()">
                            Click & Hold to Shake Dice!
                        </button>
                        <div class="roll-info" id="rollInfo">
                            Click dice to hold them between rolls
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="restart-button" onclick="restartGame()">🔄 New Game</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Yahtzee Challenge Modal -->
    <div class="yahtzee-challenge hidden" id="yahtzeeChallenge">
        <h2>🎉 YAHTZEE! 🎉</h2>
        <p style="font-size: 1.2rem; margin-bottom: 20px;">Quick! Click the button!</p>
        <button class="yahtzee-button" id="yahtzeeButton" onclick="claimYahtzee()">
            CLAIM YAHTZEE!
        </button>
        <div class="countdown" id="countdown">5 seconds remaining</div>
    </div>

    <!-- Game Over Screen -->
    <div class="game-over hidden" id="gameOver">
        <div class="game-over-content">
            <div class="winner-announcement" id="winnerText">🏆 Winner! 🏆</div>
            <div class="final-scores" id="finalScores">
                <!-- Final scores will be displayed here -->
            </div>
            <button class="restart-button" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            players: [],
            currentPlayer: 0,
            rollCount: 0,
            maxRolls: 3,
            dice: [1, 1, 1, 1, 1],
            heldDice: [false, false, false, false, false],
            scores: [],
            gamePhase: 'setup', // 'setup', 'playing', 'gameOver'
            yahtzeeTimer: null,
            roundsCompleted: 0,
            maxRounds: 13
        };

        const diceEmojis = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];

        const scoreCategories = [
            { key: 'ones', name: 'Ones', type: 'upper' },
            { key: 'twos', name: 'Twos', type: 'upper' },
            { key: 'threes', name: 'Threes', type: 'upper' },
            { key: 'fours', name: 'Fours', type: 'upper' },
            { key: 'fives', name: 'Fives', type: 'upper' },
            { key: 'sixes', name: 'Sixes', type: 'upper' },
            { key: 'threeOfKind', name: '3 of a Kind', type: 'lower' },
            { key: 'fourOfKind', name: '4 of a Kind', type: 'lower' },
            { key: 'fullHouse', name: 'Full House', type: 'lower' },
            { key: 'smallStraight', name: 'Small Straight', type: 'lower' },
            { key: 'largeStraight', name: 'Large Straight', type: 'lower' },
            { key: 'yahtzee', name: 'YAHTZEE!', type: 'lower' },
            { key: 'chance', name: 'Chance', type: 'lower' }
        ];

        // Game Initialization
        function startGame() {
            const playerInputs = [
                document.getElementById('player1').value.trim(),
                document.getElementById('player2').value.trim(),
                document.getElementById('player3').value.trim(),
                document.getElementById('player4').value.trim()
            ];

            gameState.players = playerInputs.filter((name, index) => 
                name !== '' || index < 2
            ).map((name, index) => name || `Player ${index + 1}`);

            if (gameState.players.length < 2) {
                alert('At least 2 players are required!');
                return;
            }

            // Initialize scores
            gameState.scores = gameState.players.map(() => ({}));
            gameState.gamePhase = 'playing';

            // Create scorecards
            createScorecards();

            // Switch to game screen
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.add('show');

            // Initialize first turn
            resetTurn();
            updateDisplay();
        }

        function createScorecards() {
            const scorecardContainer = document.getElementById('scorecards');
            scorecardContainer.innerHTML = '';

            gameState.players.forEach((playerName, playerIndex) => {
                const scorecard = document.createElement('div');
                scorecard.className = 'scorecard';
                scorecard.id = `scorecard${playerIndex}`;

                let html = `<div class="player-header">${playerName}</div>`;
                
                // Upper section
                html += '<div style="margin-bottom: 15px;">';
                scoreCategories.filter(cat => cat.type === 'upper').forEach(category => {
                    html += `
                        <div class="score-category" data-category="${category.key}" data-player="${playerIndex}">
                            <span class="category-name">${category.name}</span>
                            <span class="category-score" id="${category.key}-${playerIndex}">-</span>
                        </div>
                    `;
                });
                html += '</div>';

                // Lower section
                html += '<div style="margin-bottom: 15px;">';
                scoreCategories.filter(cat => cat.type === 'lower').forEach(category => {
                    html += `
                        <div class="score-category" data-category="${category.key}" data-player="${playerIndex}">
                            <span class="category-name">${category.name}</span>
                            <span class="category-score" id="${category.key}-${playerIndex}">-</span>
                        </div>
                    `;
                });
                html += '</div>';

                // Total section
                html += `
                    <div class="total-section">
                        <div style="margin-bottom: 10px;">
                            <strong>Upper Bonus: <span id="upperBonus-${playerIndex}">0</span></strong>
                        </div>
                        <div class="total-score">
                            Total: <span id="total-${playerIndex}">0</span>
                        </div>
                    </div>
                `;

                scorecard.innerHTML = html;
                scorecardContainer.appendChild(scorecard);
            });

            // Add click listeners for scoring
            document.addEventListener('click', handleScoreSelection);
        }

        // Dice Rolling Mechanics
        let isShaking = false;
        let shakeTimeout;

        function startShaking() {
            if (gameState.rollCount >= gameState.maxRolls) return;
            
            isShaking = true;
            gameState.dice.forEach((_, index) => {
                if (!gameState.heldDice[index]) {
                    document.getElementById(`die${index}`).classList.add('shaking');
                }
            });

            document.getElementById('rollButton').textContent = 'Release to Roll!';
        }

        function rollDice() {
            if (!isShaking || gameState.rollCount >= gameState.maxRolls) return;

            isShaking = false;
            
            // Stop shaking animation
            gameState.dice.forEach((_, index) => {
                document.getElementById(`die${index}`).classList.remove('shaking');
            });

            // Roll unheld dice
            gameState.dice.forEach((_, index) => {
                if (!gameState.heldDice[index]) {
                    gameState.dice[index] = Math.floor(Math.random() * 6) + 1;
                }
            });

            gameState.rollCount++;
            updateDisplay();

            // Check for Yahtzee
            if (isYahtzee() && !gameState.scores[gameState.currentPlayer].yahtzee) {
                showYahtzeeChallenge();
            }
        }

        // Touch support for mobile
        document.getElementById('rollButton').addEventListener('touchstart', (e) => {
            e.preventDefault();
            startShaking();
        });

        document.getElementById('rollButton').addEventListener('touchend', (e) => {
            e.preventDefault();
            rollDice();
        });

        // Dice holding
        gameState.dice.forEach((_, index) => {
            document.getElementById(`die${index}`).addEventListener('click', () => {
                if (gameState.rollCount > 0 && gameState.rollCount < gameState.maxRolls) {
                    gameState.heldDice[index] = !gameState.heldDice[index];
                    updateDisplay();
                }
            });
        });

        // Yahtzee Challenge System
        function showYahtzeeChallenge() {
            const challenge = document.getElementById('yahtzeeChallenge');
            challenge.classList.remove('hidden');
            
            let timeLeft = 5;
            const countdownElement = document.getElementById('countdown');
            
            gameState.yahtzeeTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = `${timeLeft} seconds remaining`;
                
                if (timeLeft <= 0) {
                    hideYahtzeeChallenge();
                }
            }, 1000);
        }

        function claimYahtzee() {
            if (gameState.yahtzeeTimer) {
                clearInterval(gameState.yahtzeeTimer);
                gameState.yahtzeeTimer = null;
            }
            
            // Auto-assign Yahtzee score
            gameState.scores[gameState.currentPlayer].yahtzee = 50;
            document.getElementById(`yahtzee-${gameState.currentPlayer}`).textContent = '50';
            document.querySelector(`[data-category="yahtzee"][data-player="${gameState.currentPlayer}"]`).classList.add('scored');
            
            hideYahtzeeChallenge();
            endTurn();
        }

        function hideYahtzeeChallenge() {
            if (gameState.yahtzeeTimer) {
                clearInterval(gameState.yahtzeeTimer);
                gameState.yahtzeeTimer = null;
            }
            document.getElementById('yahtzeeChallenge').classList.add('hidden');
        }

        // Scoring System
        function calculateScore(category, dice) {
            const counts = [0, 0, 0, 0, 0, 0, 0];
            dice.forEach(die => counts[die]++);
            const sum = dice.reduce((a, b) => a + b, 0);

            switch (category) {
                case 'ones': return counts[1] * 1;
                case 'twos': return counts[2] * 2;
                case 'threes': return counts[3] * 3;
                case 'fours': return counts[4] * 4;
                case 'fives': return counts[5] * 5;
                case 'sixes': return counts[6] * 6;
                case 'threeOfKind':
                    return counts.some(count => count >= 3) ? sum : 0;
                case 'fourOfKind':
                    return counts.some(count => count >= 4) ? sum : 0;
                case 'fullHouse':
                    const hasThree = counts.some(count => count === 3);
                    const hasTwo = counts.some(count => count === 2);
                    return hasThree && hasTwo ? 25 : 0;
                case 'smallStraight':
                    const sorted = [...new Set(dice)].sort();
                    for (let i = 0; i <= sorted.length - 4; i++) {
                        let consecutive = 1;
                        for (let j = i + 1; j < sorted.length; j++) {
                            if (sorted[j] === sorted[j-1] + 1) {
                                consecutive++;
                            } else break;
                        }
                        if (consecutive >= 4) return 30;
                    }
                    return 0;
                case 'largeStraight':
                    const sortedLarge = [...new Set(dice)].sort();
                    return sortedLarge.length === 5 && sortedLarge[4] - sortedLarge[0] === 4 ? 40 : 0;
                case 'yahtzee':
                    return isYahtzee() ? 50 : 0;
                case 'chance':
                    return sum;
                default:
                    return 0;
            }
        }

        function handleScoreSelection(event) {
            const scoreCategory = event.target.closest('.score-category');
            if (!scoreCategory || gameState.rollCount === 0) return;

            const category = scoreCategory.dataset.category;
            const playerIndex = parseInt(scoreCategory.dataset.player);

            if (playerIndex !== gameState.currentPlayer || 
                gameState.scores[playerIndex].hasOwnProperty(category)) {
                return;
            }

            // Calculate and assign score
            const score = calculateScore(category, gameState.dice);
            gameState.scores[playerIndex][category] = score;
            
            // Update display
            document.getElementById(`${category}-${playerIndex}`).textContent = score;
            scoreCategory.classList.add('scored');

            endTurn();
        }

        function endTurn() {
            updateTotals();
            
            // Check if game is over
            if (isGameComplete()) {
                endGame();
                return;
            }

            // Move to next player
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            
            // Check if round is complete
            if (gameState.currentPlayer === 0) {
                gameState.roundsCompleted++;
            }

            resetTurn();
            updateDisplay();
        }

        function resetTurn() {
            gameState.rollCount = 0;
            gameState.heldDice = [false, false, false, false, false];
            gameState.dice = [1, 1, 1, 1, 1];
        }

        function updateDisplay() {
            // Update dice
            gameState.dice.forEach((value, index) => {
                const dieElement = document.getElementById(`die${index}`);
                dieElement.textContent = diceEmojis[value - 1];
                dieElement.classList.toggle('held', gameState.heldDice[index]);
            });

            // Update turn info
            const rollText = gameState.rollCount < gameState.maxRolls ? 
                `Roll ${gameState.rollCount + 1} of ${gameState.maxRolls}` : 
                'Choose a category to score';
            document.getElementById('turnInfo').textContent = 
                `${gameState.players[gameState.currentPlayer]}'s Turn - ${rollText}`;

            // Update roll button
            const rollButton = document.getElementById('rollButton');
            rollButton.disabled = gameState.rollCount >= gameState.maxRolls;
            rollButton.textContent = gameState.rollCount >= gameState.maxRolls ? 
                'Select Score Category' : 'Click & Hold to Shake Dice!';

            // Update active scorecard
            gameState.players.forEach((_, index) => {
                const scorecard = document.getElementById(`scorecard${index}`);
                scorecard.classList.toggle('active', index === gameState.currentPlayer);
            });

            // Show potential scores
            if (gameState.rollCount > 0) {
                showPotentialScores();
            }
        }

        function showPotentialScores() {
            const playerIndex = gameState.currentPlayer;
            
            scoreCategories.forEach(category => {
                if (!gameState.scores[playerIndex].hasOwnProperty(category.key)) {
                    const potentialScore = calculateScore(category.key, gameState.dice);
                    const element = document.querySelector(`[data-category="${category.key}"][data-player="${playerIndex}"]`);
                    
                    if (element) {
                        element.classList.add('potential');
                        element.querySelector('.category-score').textContent = `(${potentialScore})`;
                    }
                }
            });
        }

        function updateTotals() {
            gameState.players.forEach((_, playerIndex) => {
                const scores = gameState.scores[playerIndex];
                
                // Calculate upper section total
                const upperTotal = (scores.ones || 0) + (scores.twos || 0) + (scores.threes || 0) + 
                                  (scores.fours || 0) + (scores.fives || 0) + (scores.sixes || 0);
                
                // Calculate upper bonus
                const upperBonus = upperTotal >= 63 ? 35 : 0;
                document.getElementById(`upperBonus-${playerIndex}`).textContent = upperBonus;
                
                // Calculate total
                let total = upperTotal + upperBonus;
                Object.keys(scores).forEach(category => {
                    if (!['ones', 'twos', 'threes', 'fours', 'fives', 'sixes'].includes(category)) {
                        total += scores[category];
                    }
                });
                
                document.getElementById(`total-${playerIndex}`).textContent = total;
            });
        }

        // Game End Conditions
        function isYahtzee() {
            return gameState.dice.every(die => die === gameState.dice[0]);
        }

        function isGameComplete() {
            return gameState.scores.every(playerScores => 
                scoreCategories.every(category => playerScores.hasOwnProperty(category.key))
            );
        }

        function endGame() {
            gameState.gamePhase = 'gameOver';
            
            // Calculate final scores and determine winner
            const finalScores = gameState.players.map((name, index) => {
                const scores = gameState.scores[index];
                const upperTotal = (scores.ones || 0) + (scores.twos || 0) + (scores.threes || 0) + 
                                  (scores.fours || 0) + (scores.fives || 0) + (scores.sixes || 0);
                const upperBonus = upperTotal >= 63 ? 35 : 0;
                
                let total = upperTotal + upperBonus;
                Object.keys(scores).forEach(category => {
                    if (!['ones', 'twos', 'threes', 'fours', 'fives', 'sixes'].includes(category)) {
                        total += scores[category];
                    }
                });
                
                return { name, total, index };
            });

            finalScores.sort((a, b) => b.total - a.total);
            
            // Display game over screen
            document.getElementById('winnerText').textContent = `🏆 ${finalScores[0].name} Wins! 🏆`;
            
            let scoresHTML = '<h3>Final Scores:</h3>';
            finalScores.forEach((player, rank) => {
                const medal = rank === 0 ? '🥇' : rank === 1 ? '🥈' : rank === 2 ? '🥉' : '';
                scoresHTML += `<div style="margin: 10px 0; font-size: 1.1rem;">
                    ${medal} ${player.name}: ${player.total} points
                </div>`;
            });
            
            document.getElementById('finalScores').innerHTML = scoresHTML;
            document.getElementById('gameOver').classList.remove('hidden');
        }

        function restartGame() {
            // Reset all game state
            gameState.players = [];
            gameState.currentPlayer = 0;
            gameState.rollCount = 0;
            gameState.dice = [1, 1, 1, 1, 1];
            gameState.heldDice = [false, false, false, false, false];
            gameState.scores = [];
            gameState.gamePhase = 'setup';
            gameState.roundsCompleted = 0;
            
            if (gameState.yahtzeeTimer) {
                clearInterval(gameState.yahtzeeTimer);
                gameState.yahtzeeTimer = null;
            }

            // Clear input fields
            document.getElementById('player1').value = '';
            document.getElementById('player2').value = '';
            document.getElementById('player3').value = '';
            document.getElementById('player4').value = '';

            // Hide all screens except setup
            document.getElementById('setupScreen').style.display = 'block';
            document.getElementById('gameScreen').classList.remove('show');
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('yahtzeeChallenge').classList.add('hidden');
        }

        // Initialize display
        updateDisplay();
    </script>
</body>
</html>